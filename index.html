<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MeteoFinder</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    #location {
      padding: 12px;
      font-size: 16px;
      width: 80%;
      border-radius: 5px;
      border: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MeteoFinder</h1>
    <input type="text" id="location" placeholder="Inserisci una localit√†" />
    <div class="buttons">
      <button onclick="getWeather()">üîç Cerca</button>
      <button onclick="saveLocation()">‚≠ê Salva</button>
    </div>
    <div id="saved-locations"></div>
    <div id="map"></div>
    <div id="weather"></div>
    <button id="forecast-link" style="display:none; margin-top: 20px;" onclick="window.location.href='previsioni_giorni.html'">
      üìÜ Vedi dettagli 3 giorni
    </button>
  </div>

  <!-- Script Google Maps + Places -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAw7XC8HkesTCpjmrLhA_uKEArxXwLizJM&libraries=places&callback=initMap" async defer></script>
  <script>
    let map, marker, autocomplete;

    function initMap() {
      const input = document.getElementById('location');
      autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['(cities)']
      });

      autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          alert('Localit√† non trovata!');
          return;
        }

        const lat = place.geometry.location.lat();
        const lng = place.geometry.location.lng();
        const placeName = place.formatted_address || place.name;
        getWeatherByCoordinates(lat, lng, placeName);
      });
    }

    function getWeather() {
      const location = document.getElementById('location').value.trim();
      if (!location) {
        alert('Inserisci una localit√†!');
        return;
      }

      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: location }, (results, status) => {
        if (status === 'OK' && results[0]) {
          const lat = results[0].geometry.location.lat();
          const lng = results[0].geometry.location.lng();
          const placeName = results[0].formatted_address;
          getWeatherByCoordinates(lat, lng, placeName);
        } else {
          alert('Localit√† non trovata!');
        }
      });
    }

    function getWeatherByCoordinates(lat, lng, placeName = '') {
      const apiKey = '889bc1d884914a61801154738250206';
      const url = `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${lat},${lng}&days=3&aqi=no&alerts=no&lang=it`;

      document.getElementById('weather').innerHTML = "<p>Caricamento dati meteo...</p>";

      fetch(url)
        .then(response => response.json())
        .then(data => {
          localStorage.setItem('forecast3days', JSON.stringify(data.forecast.forecastday));
          document.getElementById('forecast-link').style.display = 'inline-block';

          if (!map) {
            map = new google.maps.Map(document.getElementById('map'), {
              center: { lat, lng },
              zoom: 10
            });
          } else {
            map.setCenter({ lat, lng });
          }

          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({
            position: { lat, lng },
            map: map
          });

          const today = data.forecast.forecastday[0];
          let html = `
            <h3>${placeName || data.location.name}, ${data.location.region}</h3>
            <p><strong>üå° Temperatura attuale:</strong> ${data.current.temp_c}¬∞C</p>
            <p><strong>üå§ Condizioni:</strong> ${data.current.condition.text}</p>
            <img src="https:${data.current.condition.icon}" alt="Icona meteo">
            <h4>üïí Previsioni orarie per oggi (${today.date})</h4>
          `;

          const currentHour = new Date().getHours();
          today.hour.forEach(hour => {
            const hourTime = new Date(hour.time).getHours();
            if (hourTime >= currentHour) {
              const timeStr = hourTime.toString().padStart(2, '0');
              html += `<p>${timeStr}:00 - ${hour.temp_c}¬∞C, ${hour.condition.text} <img src="https:${hour.condition.icon}" alt="" /></p>`;
            }
          });

          document.getElementById('weather').innerHTML = html;
        })
        .catch(error => {
          console.error("Errore nel recupero dati:", error);
          document.getElementById('weather').innerHTML = "<p>Errore nel caricamento dei dati meteo.</p>";
        });
    }

    function saveLocation() {
      const location = document.getElementById('location').value.trim();
      if (location) {
        let saved = JSON.parse(localStorage.getItem('locations') || '[]');
        if (!saved.includes(location)) {
          saved.push(location);
          localStorage.setItem('locations', JSON.stringify(saved));
          showSavedLocations();
        }
      }
    }

    function showSavedLocations() {
      const saved = JSON.parse(localStorage.getItem('locations') || '[]');
      const div = document.getElementById('saved-locations');
      div.innerHTML = '<h4>üìç Localit√† salvate:</h4>' + saved.map(loc =>
        `<button onclick="document.getElementById('location').value='${loc}'; getWeather();">${loc}</button>`
      ).join(' ');
    }

    window.onload = () => {
      showSavedLocations();
      document.getElementById('location').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') getWeather();
      });
    };
  </script>
</body>
</html>
